###############################################################################
# NanoCloud v2.0 - Lighttpd Configuration
###############################################################################
#
# This configuration file provides security and routing rules for Lighttpd
# equivalent to the .htaccess file used for Apache.
#
# Installation:
#   1. Copy this file to /etc/lighttpd/conf-available/nanocloud.conf
#   2. Enable: sudo ln -s /etc/lighttpd/conf-available/nanocloud.conf /etc/lighttpd/conf-enabled/
#   3. Test: sudo lighttpd -t -f /etc/lighttpd/lighttpd.conf
#   4. Restart: sudo systemctl restart lighttpd
#
###############################################################################

# Document Root - Point to the public directory
server.document-root = "/local/mnt/workspace/nanocloud/project-v2/public"

# Index files
index-file.names = ( "index.php", "index.html" )

###############################################################################
# PHP FastCGI Configuration
###############################################################################

fastcgi.server += ( ".php" =>
    ((
        "bin-path" => "/usr/bin/php-cgi",
        "socket" => "/tmp/php-nanocloud.socket",
        "max-procs" => 4,
        "idle-timeout" => 20,
        "bin-environment" => (
            "PHP_FCGI_CHILDREN" => "4",
            "PHP_FCGI_MAX_REQUESTS" => "10000"
        ),
        "bin-copy-environment" => (
            "PATH", "SHELL", "USER"
        ),
        "broken-scriptfilename" => "enable"
    ))
)

###############################################################################
# Security Rules - Deny Access to Sensitive Directories
###############################################################################

# Deny access to src directory (application code)
$HTTP["url"] =~ "^/\.\./src/" {
    url.access-deny = ( "" )
}

# Deny access to config directory
$HTTP["url"] =~ "^/\.\./config/" {
    url.access-deny = ( "" )
}

# Deny access to storage directory
$HTTP["url"] =~ "^/\.\./storage/" {
    url.access-deny = ( "" )
}

# Deny access to docs directory
$HTTP["url"] =~ "^/\.\./docs/" {
    url.access-deny = ( "" )
}

# Alternative: Block any attempt to access parent directories
$HTTP["url"] =~ "\.\." {
    url.access-deny = ( "" )
}

###############################################################################
# Security Rules - Deny Access to Sensitive Files
###############################################################################

# Deny access to markdown files
$HTTP["url"] =~ "\.md$" {
    url.access-deny = ( "" )
}

# Deny access to JSON files (except in assets)
$HTTP["url"] =~ "^/(?!assets/).*\.json$" {
    url.access-deny = ( "" )
}

# Deny access to example files
$HTTP["url"] =~ "\.example$" {
    url.access-deny = ( "" )
}

# Deny access to git files
$HTTP["url"] =~ "^/\.git" {
    url.access-deny = ( "" )
}

# Deny access to .gitignore
$HTTP["url"] =~ "\.gitignore$" {
    url.access-deny = ( "" )
}

# Deny access to .htaccess (not used in Lighttpd but good practice)
$HTTP["url"] =~ "\.htaccess$" {
    url.access-deny = ( "" )
}

###############################################################################
# Performance Optimizations
###############################################################################

# Enable compression
compress.cache-dir = "/var/cache/lighttpd/compress/"
compress.filetype = (
    "text/plain",
    "text/html",
    "text/css",
    "text/javascript",
    "application/javascript",
    "application/json"
)

# Browser caching for static assets
$HTTP["url"] =~ "\.(jpg|jpeg|gif|png|svg|ico)$" {
    expire.url = ( "" => "access plus 1 years" )
}

$HTTP["url"] =~ "\.(css|js)$" {
    expire.url = ( "" => "access plus 1 months" )
}

###############################################################################
# Character Encoding
###############################################################################

# Set default charset
mimetype.assign = (
    ".html" => "text/html; charset=utf-8",
    ".txt" => "text/plain; charset=utf-8",
    ".css" => "text/css; charset=utf-8",
    ".js" => "application/javascript; charset=utf-8",
    ".json" => "application/json; charset=utf-8"
)

###############################################################################
# Directory Listing
###############################################################################

# Disable directory listing for security
dir-listing.activate = "disable"

###############################################################################
# URL Rewriting (if needed for clean URLs)
###############################################################################

# Uncomment if you need URL rewriting
# url.rewrite-if-not-file = (
#     "^/api/(.*)$" => "/api.php?$1",
#     "^/download/(.*)$" => "/download.php?$1"
# )

###############################################################################
# Additional Security Headers (optional but recommended)
###############################################################################

# Add security headers
setenv.add-response-header = (
    "X-Frame-Options" => "SAMEORIGIN",
    "X-Content-Type-Options" => "nosniff",
    "X-XSS-Protection" => "1; mode=block",
    "Referrer-Policy" => "strict-origin-when-cross-origin"
)

###############################################################################
# Error Pages (optional)
###############################################################################

# Custom error pages
# server.error-handler-404 = "/404.html"
# server.error-handler-500 = "/500.html"

###############################################################################
# Logging (optional - adjust paths as needed)
###############################################################################

# Access log
# accesslog.filename = "/var/log/lighttpd/nanocloud-access.log"

# Error log
# server.errorlog = "/var/log/lighttpd/nanocloud-error.log"

###############################################################################
# End of Configuration
###############################################################################
